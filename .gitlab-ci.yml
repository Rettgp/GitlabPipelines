image: gradle:8.4

build:
  stage: build
  script:
    - gradle buildPlugin

upload-plugin:
  stage: deploy
  needs:
    - build
  rules:
    - if: '$CI_COMMIT_TAG'
      when: on_success
    - when: never
    - when: manual
  script:
    - gradle buildPlugin
    - ls ./build/distributions/Gitlab-Pipelines-${CI_COMMIT_TAG}.zip
    - 'curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" --upload-file updatePlugins.xml "https://www.gitlab.com/api/v4/projects/51184525/packages/generic/gitlab-pipelines-plugin/updatePlugins.xml"'
    - 'curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" --upload-file "./build/distributions/Gitlab-Pipelines-${CI_COMMIT_TAG}.zip" "https://www.gitlab.com/api/v4/projects/51184525/packages/generic/gitlab-pipelines-plugin/gitlab-pipelines.zip"'


